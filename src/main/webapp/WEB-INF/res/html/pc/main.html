<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>订单列表</title>
	<!--<script src="../pc/plugins/layui/layui.js" ></script>-->
	<script src="../../layui/layui.js" ></script>
	<!--<link rel="stylesheet" href="../pc/plugins/layui/css/layui.css">-->
	<link rel="stylesheet" href="../../layui/css/layui.css">
</head>
<body>
<div>

	<!--新增-->
	<script type="text/html" id="myForm">
		<form class="layui-form layui-form-pane" action="" onsubmit="return false" id="a">
			<div class="layui-form-item">
				<label class="layui-form-label">手机</label>
				<div class="layui-input-inline">
					<input type="text" name="phone"   class="layui-input">
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label">工程师</label>
				<div class="layui-input-inline">
					<input type="text" name="mid"   class="layui-input">
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label">精度</label>
				<div class="layui-input-inline">
					<input type="text" name="lng"   class="layui-input">
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label">维度</label>
				<div class="layui-input-inline">
					<input type="text" name="lat"   class="layui-input">
				</div>
			</div>

			<!--<div class="layui-form-item">-->
			<!--<label class="layui-form-label">创建日期</label>-->
			<!--<div class="layui-input-inline">-->
			<!--<input type="text" name="createtime"  class="layui-input">-->
			<!--</div>-->
			<!--</div>-->
			<div class="layui-form-item">
				<label class="layui-form-label">需要救援的内容</label>
				<div class="layui-input-inline">
					<input type="text" name="contents"   class="layui-input">
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label">订单状态</label>
				<div class="layui-input-inline">
					<input type="text" name="status"   class="layui-input">
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label">地址</label>
				<div class="layui-input-inline">
					<input type="text" name="address"   class="layui-input">
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label">金额</label>
				<div class="layui-input-inline">
					<!--<input type="checkbox" name="cost" lay-skin="switch"   value="1"  lay-text="锁定|可用" >-->
					<input type="text" name="cost"   class="layui-input">
				</div>
			</div>

			<button  class="layui-btn layui-hide" lay-submit lay-filter="userAddForm" id="userAddForm">立即提交</button>
		</form>
	</script>

	<!--修改-->
	<script type="text/html" id="myForm02">
		<form class="layui-form layui-form-pane" id="form1" action="" method="get" style="text-align: center">
			<div class="layui-inline">
				<div class="layui-form-item">
					<!--<div class="layui-inline">-->
					<label class="layui-form-label">工程师编号</label>
					<div class="layui-input-block">
						<input type="text" name="mid" class="layui-input"/>
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">手机</label>
					<div class="layui-input-block">
						<input type="password" name="phone" class="layui-input"/>
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">经度</label>
					<div class="layui-input-block">
						<input type="text" name="lng" class="layui-input"/>
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">纬度</label>
					<div class="layui-input-block">
						<input type="text" name="lat" class="layui-input"/>
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">救援内容</label>
					<div class="layui-input-inline">
						<select name="contents" lay-filter="aihao" >
							<option value=""></option>
							<option value="补胎">补胎</option>
							<option value="搭电">搭电</option>
							<option value="电瓶搭电">电瓶搭电</option>
						</select>
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">订单状态</label>
					<div class="layui-input-inline">
						<select name="status" lay-filter="aihao" >
							<option value=""></option>
							<option value="0">刚下单</option>
							<option value="1">已接单</option>
							<option value="2">已到达正在修</option>
							<option value="3">已完成</option>
						</select>
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">地址</label>
					<div class="layui-input-block">
						<input type="text" name="address" class="layui-input"/>
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">金额</label>
					<div class="layui-input-block">
						<input type="text" name="cost" class="layui-input"/>
					</div>
				</div>
				<div class="layui-form-item">
					<div class="layui-input-block">
	<button  class="layui-btn layui-hide" lay-submit lay-filter="userAddForm" id="userAddForm02">立即提交</button>
		</div>
		</div>
		</div>
		</form>
	</script>





	<div class="layui-row">
		<form class="layui-form layui-form-pane" action="">
			<div class="layui-form-item">


				<label class="layui-form-label">手机号</label>
				<div class="layui-input-inline">
					<input type="text" name="phone" class="layui-input">
				</div>


				<label class="layui-form-label">救援内容</label>
				<div class="layui-input-inline">
					<select name="contents" lay-filter="aihao" >
						<option value=""></option>
						<option value="补胎">补胎</option>
						<option value="搭电">搭电</option>
						<option value="电瓶搭电">电瓶搭电</option>
					</select>
				</div>

				<label class="layui-form-label">订单状态</label>
				<div class="layui-input-inline">
					<select name="status" lay-filter="aihao" >
						<option value=""></option>
						<option value="0">刚下单</option>
						<option value="1">已接单</option>
						<option value="2">已到达正在修</option>
						<option value="3">已完成</option>
					</select>
				</div>



				<div class="layui-input-inline">
					<button type="submit" class="layui-btn" lay-submit="" lay-filter="searchBtn">搜索</button>
				</div>

			</div>
		</form>
		<table class="layui-hide" id="test" lay-filter="test"></table>

		<script type="text/html" id="toolbarDemo">
			<div class="layui-btn-container">
				<button class="layui-btn layui-btn-sm" lay-event="add">新增订单</button>
				<button class="layui-btn layui-btn-sm" lay-event="updStatus">修改状态</button>

				<button class="layui-btn layui-btn-sm" lay-event="upd">修改订单</button>
				<button class="layui-btn layui-btn-sm" id="excelDown" lay-event="excelDown"><i class=" layui-icon layui-icon-download-circle">Excel下载</i></button>
			</div>
		</script>


		<script type="text/html" id="barDemo">
			<a class="layui-btn layui-btn-xs" lay-event="sendMaster">派单</a>
			<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="relieve">解除派单</a>
            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="relieve1">删除</a>
		</script>

	</div>


</div>

<script>
	layui.use(['element', 'form', 'jquery', 'table', 'util' ,'layer' ], function () {
		var element = layui.element;
		var form = layui.form;
		var $ = layui.jquery;
		var table = layui.table;
		var util = layui.util;
		var layer = layui.layer;



		// 监听 新增的按钮
		form.on('submit(userAddForm)', function(data){
			console.log(data.field)
			//   layer.msg(JSON.stringify(data.field));
			// 发送 ajax 提交到后台..
			$.ajax({
				url:'/orders/inOrders',
				type:'POST',
				data:data.field,
				success:function (res) {
					console.log(res)
					if (res.code==0) {
						layer.msg("添加成功")
					}else{
						layer.msg("添加失败, 请重新再来一次")
					}
				},
				dataType:'json'
			});
			return false;
		});

		// 监听搜索的按钮
		form.on('submit(searchBtn)', function (data) {
			// layer.msg(JSON.stringify(data.field));
			console.log(data.field);
			// 执行表格重载
			table.reload('test', {
				where: { //设定异步数据接口的额外参数，任意设
					//  aaaaaa: 'xxx'
					//, bbb: 'yyy'
					//   username: data.field.username
					///   , realName: data.field.realName
					// , type: data.field.type  contents  status
					phone:data.field.phone,
					cost:data.field.cost,
					contents:data.field.contents,
					status:data.field.status
				}
				, page: {
					curr: 1 //重新从第 1 页开始
				}
			}); //只重载数据
			return false;
		});


		table.render({
			elem: '#test'
			,url:'/orders/selectAllByPage'
			,toolbar: '#toolbarDemo' //开启头部工具栏，并为其绑定左侧模板
			,defaultToolbar: ['filter', 'exports', 'print', { //自定义头部工具栏右侧图标。如无需自定义，去除该参数即可
				title: '提示'
				,layEvent: 'LAYTABLE_TIPS'
				,icon: 'layui-icon-tips'
			}]
			,title: '用户数据表'
			,cols: [[
				{type: 'checkbox', fixed: 'left'}
				,{field:'id', title:'订单号', width:80, fixed: 'left', unresize: true, sort: true}
				,{field:'mid', title:'工程师编号', edit: 'text'}
				,{field:'phone', title:'手机', width:150}
				,{field:'lng', title:'经度', width:180}
				,{field:'lat', title:'维度', width:180}
				,{field:'createtime', title:'创建日期', width:180}
				,{field:'contents', title:'需要救援的内容', width:150}
				,{field:'status', title:'状态', templet:status}
				,{field:'address', title:'地址',width:100}
				,{field:'cost', title:'金额',width:100}
				,{fixed: 'right', title:'操作', toolbar: '#barDemo'}
			]]
			,page: true
			,parseData: function(res){ //res 即为原始返回的数据
				return {
					"code": res.code, //解析接口状态   重点和难点!!!
					"msg": res.msg, //解析提示文本
					"count": res.count, //解析数据长度
					"data": res.pageInfo.list //解析数据列表
				};
			}
		});
		// 监听 开关
		form.on('switch(switchTest)',function (obj) {
			console.log("切换了按钮");
			console.log(obj);
		});

//监听行工具事件
  table.on('tool(test)', function(obj){
    var data = obj.data;
    if(obj.event === 'relieve'){
      layer.confirm('是否解除派单', function(index){
    	$.post("/orders/UpdateOrders",{"id":data.id},function(data){
    		layer.alert("解除成功！");
    	});
        window.parent.location.reload("/res/html/pc/main.html");
      });
    }else if(obj.event === 'sendMaster'){
    	order = data;
    	$.ajax({
			type:'post',
			url:'/api/master/selectById',
			data:{"id":data.id},
			dataType:'JSON',
			success:function (data) {
				if (data.data!=null){
					layer.open({
						type: 2,
						skin: 'layui-layer-demo', //样式类名
						title: '派单',
						closeBtn: 1, //不显示关闭按钮
						anim: 2,
						maxmin: true,
						area: ['60%', '60%'],
						shadeClose: true, //开启遮罩关闭
						content: '/res/html/pc/Masterxiala.html',
						end:function () {
							location.reload();
						}
					});
				} else {
					alert("派单失败")
				}
			}
		})
    }else if(obj.event === 'relieve1'){
		layer.confirm('是否删除', function(index){
			$.post("/orders/deleteById",{"id":data.id},function(data){
				layer.alert("删除成功！");
			});
			window.parent.location.reload("/res/html/pc/main.html");
		});
	}

  });

  //工具栏事件
  table.on('toolbar(test)', function(obj){
    var checkStatus = table.checkStatus(obj.config.id);
    switch(obj.event){
       case 'add':
		   //layer.msg("我是新增")
		   layer.open({
			   title: '新增',
			   type: 1,
			   content: $('#myForm').html(),
			   area: ['890px', '680px'],
			   btn: ['确定', '返回'],
			   yes: function (index, layero) {
				   $("#userAddForm").click();
				   parent.layer.class();
			   },
			   shadeClose: false,
			   success: function (index, layero) {
				   form.render(); // 渲染全部
			   }
		   });
		   break;
       case 'sendMaster':
	    	   var data = checkStatus.data;
		       if(data.length!=1){
		    	   layer.msg("请选择一个订单！");
		    	   return false;
		       }else{
	    	     	order = checkStatus.data[0];
			   	 	layer.open({
				         type: 2,
				         skin: 'layui-layer-demo', //样式类名
				         title: '派单',
				         closeBtn: 1, //不显示关闭按钮
				         anim: 2,
				         maxmin: true,
				         area: ['100%', '100%'],
				         shadeClose: true, //开启遮罩关闭
				         content: '/order/sendMaster'
			     	});
		      }
	      	  break;
      	case 'updStatus':
		   var 	data = checkStatus.data;
		   order=checkStatus.data[0];
		   if (data.length!=1){
		   	layer.msg("请选择一个订单");
		   	return;
		   } else {
			   $.ajax({
				   type: 'post',
				   url: '/api/master/selectById',
				   data: {"id": order.id},
				   dataType: 'JSON',
				   success: function (data) {
					   layer.open({
						   type: 2,
						   skin: 'layui-layer-demo', //样式类名
						   title: '修改状态',
						   closeBtn: 1, //不显示关闭按钮
						   anim: 2,
						   maxmin: true,
						   area: ['60%', '60%'],
						   shadeClose: true, //开启遮罩关闭
						   content: '/res/html/pc/upOrders.html',
						   end: function () {
							   location.reload();
						   }
					   });
		   }
		   })
		   }
	 	   	// layer.open({
	 	    //      type: 2,
	 	    //      skin: 'layui-layer-demo', //样式类名
	 	    //      title: '修改',
	 	    //      closeBtn: 1, //不显示关闭按钮
	 	    //      anim: 2,
	 	    //      maxmin: true,
	 	    //      area: ['60%', '60%'],
	 	    //      shadeClose: true, //开启遮罩关闭
	 	    //      content: '/order/updStatus'
	        break;
        case 'getCheckLength':
           var data = checkStatus.data;
	       if(data.length!=1){
	    	   layer.msg("一次只能指派一个订单！");
	    	   return false;
	       }else{
	    	 //弹出一个新的页面，页面跳转只能经过后台
	        	layer.open({
	    			type: 2,
	    			title:["页面"],
	    			area: ['100%', '100%'],
	    			maxmin:true,
	    			scrollbar: false ,
	    			content:'toUpdatePage'
	    		});
	       }
      break;
      case 'isAll':
        layer.msg(checkStatus.isAll ? '全选': '未全选')
      break;
      case 'upd':
		  var 	data = checkStatus.data;
		  order=checkStatus.data[0];
		  if (data.length!=1){
			  layer.msg("请选择一个订单");
			  return;
		  } else {
			  $.ajax({
				  type: 'post',
				  url: '/api/master/selectById',
				  data: {"id": order.id},
				  dataType: 'JSON',
				  success: function (data) {
					  layer.open({
						  type: 2,
						  skin: 'layui-layer-demo', //样式类名
						  title: '修改订单',
						  closeBtn: 1, //不显示关闭按钮
						  anim: 2,
						  maxmin: true,
						  area: ['60%', '60%'],
						  shadeClose: true, //开启遮罩关闭
						  content: '/res/html/pc/OdersUpdate.html',
						  end: function () {
							  location.reload();
						  }
					  });
				  }
			  })
		  }
        break;
    };
  });
});
function status(d){
	var str="";
	if(d.status=='-1'){
		str="已作废";
	}
	if(d.status=='0'){
		str="刚下单";
	}
	if(d.status=='1'){
		str="已接单";
	}
	if(d.status=='2'){
		str="已到达正在修";
	}
	if(d.status=='3'){
		str="已完成";
	}
	if(d.status=='4'){
		str="已评价";
	}
	return str;
}
</script>

</body>
</html>